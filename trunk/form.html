<!doctype html>
<html><head><title>Chargeback: New</title>
<link rel="stylesheet" href="chargeback.css">
<script src="common.js"></script>
<script src="chargeback.js"></script>

</head><body>
<div class="headerbar blackbar">
    <div class="container_12">
        <div class="grid_12">
            <a class="view_link"><h1 class="logo">Chargeback</h1></a>
            <div class="caption">
                <a class="button" href="upload.html"><span>Upload</span></a>
                <a class="button view_link"><span>View data</span></a>
            </div>
        </div>
    </div>
</div>

<form class="container_12 form main">
    <fieldset class="grid_6">
      <table>
        <tr><td colspan="3"><h2>Chargeback information</h2></td></tr>
        <tr><td>Business</td><td>
            <select name="dept" id="dept" class="required">
                <option value="Direct" selected="selected">Direct</option>
                <option value="Books">Books</option>
                <option value="Clothing">Clothing</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Wine">Wine</option>
            </select>
        </td><td></td></tr>
        <tr><td>Bank</td><td>
            <select name="bank" id="bank" class="required">
                <option value="Amex" selected="selected">Amex</option>
                <option value="HSBC">HSBC</option>
                <option value="RBS">RBS</option>
            </select>
        </td><td></td></tr>
        <tr><td>Chargeback type</td><td>
            <select name="type" id="type" class="required">
                <option value="RFI" selected="selected">RFI</option>
                <option value="CB">Chargeback</option>
                <option value="RFICB">RFI to CB</option>
                <option value="BRF">Bank fraud</option>
            </select>
        </td><td></td></tr>
        <tr><td>Case ref #</td><td>
            <input name="caseref" id="caseref" class="required">
            </td><td><ul id="matchref"></ul>
        </td></tr>
        <tr><td title="Only the last 4 digits of the card number will be stored, for PCI compliance purposes. This is usually enough to identify the order.">
            Card (last 4 digits)
            </td><td><input type="number" name="card" id="card" class="required" maxlength="4">
            </td><td rowspan="3"><ul id="matchcard"></ul>
        </td></tr>
        <tr><td title="The amount the chargeback is for. This is often the full order value. But in case the dispute is about a part of an order, can be less than the order value.">
            Chargeback amount
            </td><td><input type="number" name="amt" id="amt" class="required">&#163;</td></tr>
        <tr><td title="The date on which the chargeback was processed by the bank.">
            Case date
            </td><td><input type="date" name="on" id="on" class="required"></td></tr>
        <tr><td>Respond by</td><td colspan="2"><input type="date" name="sla" id="sla"></td></tr>
        <tr><td>Bank ref #</td><td colspan="2"><input name="bankref" id="bankref"></td></tr>
        <tr><td>Debit / Credit</td><td colspan="2">
            <select name="debit_credit" id="debit_credit" class="required">
                <option value="Debit" selected="selected">Debit</option>
                <option value="Credit">Credit</option>
            </select>
        </td></tr>
        <tr><td>Order ID</td><td colspan="2"><input name="order" id="order"></td></tr>
        <tr><td title="The date on which the order was placed.">
            Order date
            </td><td><input type="date" name="ordered" id="ordered"></td></tr>
        <tr><td>Order Ref</td><td colspan="2"><input name="ref" id="ref"></td></tr>
        <tr><td>Order value</td><td colspan="2"><input name="value" id="value">&#163;</td></tr>
        <tr><td>Seller ID</td><td colspan="2"><input name="seller" id="seller"></td></tr>
        <tr><td>Charge seller?</td><td colspan="2"><input type="checkbox" checked="checked" name="chargeseller" id="chargeseller"></td></tr>
        <tr><td>Seller disputed?</td><td colspan="2"><input type="checkbox" name="disputed" id="disputed"></td></tr>
      </table>
    </fieldset>

    <fieldset class="grid_6">
      <table>
        <tr><td colspan="2"><h2>Status</h2></td></tr>
        <tr><td>Reason code</td><td>
            <select name="reason" id="reason" class="required">
                <option class="Open">Open</option>
                <optgroup   label="Awaited">
                    <option class="Awaited">Documents awaited</option>
                </optgroup>
                <optgroup   label="Sent">
                    <option class="Sent">Evidence sent. Bank response awaited</option>
                </optgroup>
                <optgroup   label="Success">
                    <option class="Success">Chargeback was prevented</option>
                    <option class="Success">Awaiting credit</option>
                    <option class="Success">Credit received</option>
                </optgroup>
                <optgroup   label="Failure">
                    <option class="Failure">Evidence not received by bank</option>
                    <option class="Failure">Unjustified debit</option>
                    <option class="Failure">Awaiting debit</option>
                    <option class="Failure">Cardholder's name doesn't match order invoice</option>
                    <option class="Failure">Customer did not authorise transaction</option>
                    <option class="Failure">AMEX - card not present</option>
                    <option class="Failure">AMEX - Store collection with no card swipe</option>
                    <option class="Failure">Justified debit</option>
                    <option class="Failure">Paper letter debit received</option>
                </optgroup>
                <optgroup   label="Unrecognised">
                    <option class="Unrecognised">Order ID unrecognised</option>
                </optgroup>
                <optgroup   label="Expired">
                    <option class="Expired">No opportunity to challenge</option>
                    <option class="Expired">Timed out - legal obligation</option>
                    <option class="Expired">Insufficient time to respond</option>
                </optgroup>
                <optgroup   label="Ignored">
                    <option class="Ignored">Item not collected</option>
                    <option class="Ignored">Refused at door</option>
                    <option class="Ignored">S&amp;R Action &amp; Refund not given</option>
                    <option class="Ignored">Lost in transit</option>
                </optgroup>
                <optgroup   label="NoInfo">
                    <option class="NoInfo">HDN failed to provide POD</option>
                    <option class="NoInfo">Store failed to provide info</option>
                    <option class="NoInfo">CEVA failed to provide POD</option>
                    <option class="NoInfo">EXPERT failed to provide POD</option>
                    <option class="NoInfo">Other courier failed to provide POD</option>
                    <option class="NoInfo">HSC failed to provide info</option>
                </optgroup>
                <optgroup   label="LiabilityShift">
                    <option class="LiabilityShift">AMEX liability shift</option>
                </optgroup>
            </select>
        </td></tr>
        <tr><td>Status</td><td>
            <input name="status" id="status" value="Open">
        </td></tr>
        <tr><td>DASH</td><td>
            <select name="dash" id="dash">
                <option value="pending">Pending</option>
                <option value="done">Done</option>
            </select>
        </td></tr>
        <tr><td>Refund</td><td>
            <select name="refund" id="refund">
                <option value="na">n/a</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </td></tr>
        <tr><td>POD</td><td>
            <select name="pod" id="pod">
                <option value="pending">Pending</option>
                <option value="received">Received</option>
                <option value="unavailable">Unavailable</option>
            </select>
        </td></tr>
        <tr><td>Covering letter</td><td>
            <select name="cover" id="cover">
                <option value="pending">Pending</option>
                <option value="done">Done</option>
            </select>
            <a target="_blank" class="button template_link" href="/template.html" id="cover_letter"><span>Create</span></a>
        </td></tr>
        <tr><td>User ID</td><td><input name="user" id="user" class="required"></td></tr>
        <tr><td colspan="2">
            Notes
            <textarea name="notes" id="notes" rows="5"></textarea>
        </td></tr>
      </table>
    </fieldset>

    <div class="grid_12">
        <table>
        <tr><td>Bank reason code:</td>
        <td><select name="why" id="why">
            <option value="" selected="selected"></option>
            <optgroup label="MasterCard">
                <option value="M01">01. No Response received to Retrieval Request</option>
                <option value="M02">02. Retrieval Request Response – Illegible or Missing Information</option>
                <option value="M07">07. Hot Card File</option>
                <option value="M08">08. Transaction not Authorised or Authorisation declined</option>
                <option value="M12">12. Card number processed does not exist</option>
                <option value="M31">31. Amount processed differs to that agreed by cardholder</option>
                <option value="M34">34. Same transaction processed more than once</option>
                <option value="M35">35. Expired card</option>
                <option value="M37">37. Fraudulent transaction</option>
                <option value="M40">40. Fraudulent transactions taken over a short space of time</option>
                <option value="M41">41. Cardholder cancelled a Recurring Transaction</option>
                <option value="M42">42. Transaction processed more than 6 days after transaction date</option>
                <option value="M46">46. Cardholder charged in a different currency to that quoted</option>
                <option value="M47">47. Transaction not authorised – Fraudulent transaction</option>
                <option value="M49">49. Excessive Fraudulent Transactions – Advised by Fraud</option>
                <option value="M50">50. Refund processed as a Sale</option>
                <option value="M53">53. Cardholder received damaged or not as described goods</option>
                <option value="M55">55. Ordered goods not received</option>
                <option value="M57">57. Fraudulent card-activated telephone transaction</option>
                <option value="M59">59. Services ordered by cardholder not received</option>
                <option value="M60">60. Refund not processed to cardholder</option>
                <option value="M62">62. Fraudulent transaction – counterfeit card</option>
                <option value="M63">63. Cardholder does not recognise transaction</option>
                <option value="M64">64. Correct chip card procedure not followed – Counterfeit card</option>
                <option value="M70">70. Correct chip card procedure not followed – Lost/Stolen card</option>
            </optgroup>
            <optgroup label="Visa">
                <option value="V30">30. Ordered goods not received</option>
                <option value="V41">41. Cardholder cancelled a Recurring Transaction</option>
                <option value="V53">53. Cardholder received damaged or not as described goods</option>
                <option value="V57">57. Fraudulent transactions taken over a short space of time</option>
                <option value="V60">60. Retrieval Request Response – Illegible or Missing Information</option>
                <option value="V62">62. Fraudulent transaction – counterfeit card</option>
                <option value="V70">70. Hot Card File</option>
                <option value="V72">72. Transaction not Authorised or Authorisation declined</option>
                <option value="V73">73. Expired card</option>
                <option value="V74">74. Transaction processed more than 6 days after transaction date</option>
                <option value="V75">75. Cardholder does not recognise transaction</option>
                <option value="V76">76. Cardholder charged in a different currency to that quoted</option>
                <option value="V77">77. Card number processed does not exist</option>
                <option value="V80">80. Amount processed differs to that agreed by cardholder</option>
                <option value="V81">81. Correct chip card procedure not followed – Lost/Stolen card</option>
                <option value="V82">82. Same transaction processed more than once</option>
                <option value="V85">85. Refund not processed to cardholder</option>
                <option value="V93">93. Excessive Fraudulent Transactions – Advised by Fraud</option>
            </optgroup>
        </select></td></tr>
        <tr><td colspan="2">
            <span class="button"><button type="submit">Save</button></span>
            <div id="validation_error">The fields marked in red must be filled in.</div>
            <div id="server_error"><p>Something went wrong with the server.</p><p>Tell technical support what you did, and that the server said: <span class="message"></span></p></div>
            <div id="server_success">Saved with ID <span class="message"></span>.<br>You can continue editing this form, or<br><a href="">Start another chargeback</a><br><a href="view.html?orderby=-time">View the latest records</a></div>
        </td></tr>
        </table>
    </div>

    <div class="grid_12 hist">
    </div>

</form>
<form><input type="hidden" name="id" id="id"></form>

<script type="text/javascript">
// Validation and recommendation logic
function isvalid() {
    for (var req = $('input.required,select.required'), l=req.length, i=0; i<l; i++) {
        if (!req.eq(i).val()) { return false; }
    }
    return true;
}
function showvalidation(isvalid) {
    $('#validation_error,#server_error,#server_success').hide();
    if (!isvalid) { $('#validation_error').slideDown(200); }
}

$.fn.getFields = function() {
    for (var i=0, f=this.serializeArray(), x, out = {}; x=f[i]; i++) {
        out[x.name] = x.value;
    }
    return out;
}

function show_hist(hist) {
    var html = [];
    for (var i=0, h; h=hist[i]; i++) {
        html.push('<p>', h[0][0], ' (', new Date(h[0][1]).toLocaleString(), ')</p><ul>');
        for (var j=1, c; c=h[j]; j++) {
            html.push('<li>', c[0], ': <ins>', c[1], '</ins> <del>', c[2], '</del></li>');
        }
        if (j == 1) { html.push('<li>Created</li>'); }
        html.push('</ul>');
    }
    $('.hist').html(html.join(''));
}

function matchref() {
    $('#matchref').html('');
    $('#server_error').hide();
    var data = fields2data($('.form').getFields()),
        id = $('#id').val();
    if (data.caseref) {
        $.ajax({type: 'GET', url: '/Chargeback/?caseref="' + data.caseref + '"' + (id ? '&id!=' + $('#id').val() : ''), dataType: 'json', success: function(data) {
            for (var i=0, d; d=data[i]; i++) {
                var f = data2fields(d);
                $('#matchref').append(['<li><a tabindex="-1" href="/form.html?id=', d.id, '">', f.bank, ' ', f.type, ' for &#163;', f.amt, ' on ', f.on, '</a></li>'].join(''));
            }
        }, error: function(xhr) {
            $('#server_error .message').html(xhr.responseText);
            $('#server_error').slideDown(200);
        }});
    }
}

function matchcard() {
    $('#matchcard').html('');
    $('#server_error').hide();
    var data = fields2data($('.form').getFields()),
        id = $('#id').val(),
        onrange = 86400000 * 2,
        amtrange = 100;
    if (data.card && data.amt && data.on) {
        $.ajax({type: 'GET', url: '/Chargeback/?card="' + data.card + '"&amt>' + (data.amt-amtrange) + '&amt<' + (data.amt+amtrange) + '&on>' + (data.on-onrange) + '&on<' + (data.on+onrange) + (id ? '&id!=' + $('#id').val() : ''), dataType: 'json', success: function(data) {
            for (var i=0, d; d=data[i]; i++) {
                var f = data2fields(d);
                $('#matchcard').append(['<li><a tabindex="-1" href="/form.html?id=', d.id, '">', f.bank, ' ', f.type, ' for &#163;', f.amt, ' on ', f.on, '</a></li>'].join(''));
            }
        }, error: function(xhr) {
            $('#server_error .message').html(xhr.responseText);
            $('#server_error').slideDown(200);
        }});
    }
}

// Focus change logic. Doesn't seem to work with IE6, so just exclude that
if (!$.browser.msie || $.browser.version >= "7") {
    $('td input, td select').focus(function() { $(this).parents('tr:first').addClass('highlight');    })
                            .blur (function() { $(this).parents('tr:first').removeClass('highlight'); })
                            .change(function() { showvalidation(isvalid); });
}

// Form submission logic
$('form').submit(function() {
    // Validate
    var v = isvalid();
    showvalidation(v);
    if (!v) { return false; }
    // Compute
    var now = (new Date()).getTime(),
        olddata = $('.form').data('originaldata'),
        fields = $('.form').getFields(),
        data = fields2data(fields),
        user = $('#user').data('current_user') || $('#user').val(),
        changes = [ [user, now] ];
    if (olddata) {
        var oldfields = data2fields(olddata);
        for (var field in fields) {
            if (fields[field] && fields[field] !== oldfields[field]) {
                changes.push([field, fields[field], oldfields[field]]);
            }
        }
        if (changes.length == 1) { return false; }
        data.hist = olddata.hist;
    }
    else { data.hist = []; }
    data.hist.push(changes);
    data.time = now;
    data.user = user;

    $.ajax({type:'POST', url: '/Chargeback/' + $('#id').val(), dataType: 'json', data: JSON.stringify(data), success: function(data) {
        $('#server_success .message').text(data.id);
        $('#id').val(data.id);
        $('#server_success').slideDown(200);
        $('.form').data('originaldata', data);
        show_hist(data.hist);
    }, error: function(xhr) {
        $('#server_error .message').html(xhr.responseText);
        $('#server_error').slideDown(200);
    }});
    return false;
});

// Initialise the form if an ID is provided
if ($.query.get('id')) {
    $.ajax({type: 'GET', url: '/Chargeback/' + $.query.get('id'), dataType: 'json', success: function(data) {
        var fields = data2fields(data);
        $('.form').data('originaldata', data);
        $('#id').val(data.id);
        $('.template_link').attr('href', '/template.html?id=' + data.id)
        for (var key in fields) { $('#' + key).val(fields[key]); }
        show_hist(fields.hist);
        showvalidation(isvalid());
        inituser('#user');
        matchcard();
        matchref();
    }});
} else {
    inituser('#user');
    $('.template_link').hide();
}

// Order lookup
$('<a href="#">Find Ref</a>').insertAfter('#order').click(function(e) {
    e.preventDefault();
    var input = fields2data($('.form').getFields()),
        search = [input.order, input.ordered || '', input.amt || ''].join(',');
    $.getJSON('/order?search=' + search, function(data) {
        if (data.length == 1 && data[0][1] == input.order) {
            $('#ref').val(data[0][0]);
            // Assume format is Excel standard "d/m/yyyy hh:mm:ss"
            var datestr = data[0][2].split(/[^0-9]/),
                date = new Date(+datestr[2], +datestr[1]-1, +datestr[0]);
            $('#ordered').val(date.asString());
            $('#value').val(data[0][3]);
            $('#order_info').html('Found.');
        }
        else if (data.length > 1) {
            var s=['<table><tr><th>Ref</th><th>ID</th><th>Date</th><th>Amt</th></tr>'];
            for (var i=0, d; d=data[i]; i++) {
              s.push('<tr><td>' + d.join('</td><td>') + '</td></tr>');
            }
            $('#order_info').html(s.join(''));
        } else { $('#order_info').html('Not found'); }
    });
}).after('<div id="order_info"></div>');

// Status lookup
$('#reason').change(function() {
    $('#status').val($('#reason option:contains(' + $('#reason').val().replace("'", "\\'") + ')').attr('class'));
});
$('#status').focus(function() {
    $('#dash').focus();
});


// Datepicker initialisation
$('#on,#sla,#ordered').datePicker({startDate:'2000-01-01'});
$('#on').bind('dateSelected', function(e, d) { $('#sla').val(d.addDays(14).asString()); }).dpSetSelected((new Date()).asString());
$('.dp-choose-date').attr('tabIndex', -1);

// Focus changes
$('input,select').eq(0).focus();
$('#caseref').change(matchref);
$('#card,#amt,#on').change(matchcard);

$('#amt').change(function() { $('#value').val($('#value').val() || $(this).val()); });

</script>

</body></html>
